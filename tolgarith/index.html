<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Labyrinth of Tolgarith</title>
    <style>
        *{
            box-sizing: border-box;
            margin:auto;
            position:relative;
            font-family: monospace;
        }


        html,body{
            margin:0px;
            width:100%;
            height:100%;
        }

        p, div{
            line-height: 1.5em;
        }

        button{
            margin:5px;
            padding:10px;
            border:none;
            background:#000;
            color:#fff;
        }
        
        p{
            margin:25px;
        }

        body{
            text-align:left;
        }

        hr{
            margin:20px 0px;
            border:none;
            border-bottom:solid 1px #000;
        }

        h1{
            margin:10px 0px;
            position:fixed;
            bottom:10px;
            right:25px;
            opacity:0.25;
        }

        tr,td,table{
            border:solid 1px #000;
            border-collapse: collapse;
        }

        table{
            margin:10px;
        }

        td{
            padding:5px;

        }

        .page{
            padding:10px;
            margin:10px;
            display:block;
            width:calc(100% - 20px);
            height:90%;
            border:solid 1px #000;
        }

        .hpContainer{
            display:flex;
            width:fit-content;
        }

        .hpContainer button{
            background:hsl(0,50%,50%);
        }

        #optionsContainer{
            display:flex;
            margin:10px;
            text-align:left;
            width:fit-content;
        }

        .gold{
            height:37px;
            padding:5px;
            outline:none;
            margin:5px;
            text-align:center;
            border:solid 1px #000;
        }

        .inventory{
            display:flex;
            float:right;
            height:800px;
            width:200px;
            outline:none;
            padding:10px;
        }

        tr:nth-child(1){
            font-weight: bold;
        }

        @media print{
            #optionsContainer{
                display:none;
            }

            .page{

                width:8.5in;
                height:11in;
                border:none;
                padding:auto;
                margin:auto;
            }

            td{
                font-size:8px;
            }
            
            table,tr,td{
                border:solid 1px #000 !important;
            }

            table{
                margin:25px;
            }

            h2{
                font-size:16px;
                margin:25px;
            }

            .noprint{
                display:none;
            }
        }

    </style>
</head>
<body>


    <h1>The Labyrinth of Tolgarith</h1>
    <!--
    <div class="page">
    <table>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
    </table>
    -->
    <div id="optionsContainer"></div>
</div>
    <script>
        
        const inventory = document.createElement('textarea');
        document.body.appendChild(inventory);
        inventory.className = 'inventory noprint';

        inventory.addEventListener('keyup',function(){
            localStorage.inventory = inventory.value;
        },false);

        inventory.value = localStorage.inventory || '';

        let hp = 10;
        let maxHP = 10;
        const hpDisplay = document.createElement('canvas');
        hpDisplay.width = 300;
        hpDisplay.height = 37;
        const hpContainer = document.createElement('div');

        hpContainer.className = 'hpContainer';

        const hpUp = document.createElement('button');
        hpUp.textContent = '>'
        hpUp.addEventListener('mousedown',function(){
            hp += 1;
            if(hp > maxHP){
                hp = maxHP;
            }
            updateHPDisplay();
        })

        const hpDown = document.createElement('button');
        hpDown.textContent = '<'
        hpDown.addEventListener('mousedown',function(){
            hp -= 1;
            if(hp < 0){
                hp = 0;
            }
            updateHPDisplay();
        })


        const maxHPUp = document.createElement('button');
        maxHPUp.textContent = '>>'
        maxHPUp.addEventListener('mousedown',function(){
            maxHP += 1;
            hp += 1;
            updateHPDisplay();
        })

        const maxHPDown = document.createElement('button');
        maxHPDown.textContent = '<<'
        maxHPDown.addEventListener('mousedown',function(){
            maxHP -= 1;
            if(maxHP < 1){
                maxHP = 1;
            }
            if(maxHP < hp){
                hp = maxHP;
            }
            updateHPDisplay();
        })

        hpContainer.appendChild(maxHPDown)        
        hpContainer.appendChild(hpDown)        
        hpContainer.appendChild(hpDisplay);
        hpContainer.appendChild(hpUp)        
        hpContainer.appendChild(maxHPUp)      
        
        updateHPDisplay();

        const gold = document.createElement('input');
        gold.className = 'gold';
        gold.placeholder = "Gold";

        gold.addEventListener('focus',function(){
            gold.value = gold.value.split('gold').join('').trim()
            gold.select();
        },false);

        gold.addEventListener('blur',function(){
            gold.value = gold.value.trim() + ' gold';
            localStorage.gold = gold.value;
        },false);

        gold.value = localStorage.gold || "0 gold";

        function updateHPDisplay(){
            const ctx = hpDisplay.getContext('2d');
            ctx.clearRect(0,0,hpDisplay.width,hpDisplay.height);
            const step = hpDisplay.width/maxHP;
            ctx.strokeStyle = ctx.fillStyle = 'hsl(0,50%,50%)'
            ctx.lineWidth = 2;
            ctx.save();
            for(let i = 0; i < maxHP; i++){
                ctx.strokeRect(step*i,0,step,hpDisplay.height);
            }
            for(let i = 0; i < hp; i++){
                ctx.fillRect(step*i+4,4,step-8,hpDisplay.height-8);
            }
            ctx.restore();
        }

        const tileOptions = "ðŸ»ðŸª¨ðŸŽðŸ¦‡ðŸ•·ï¸ðŸ¦‚";

        let wave = 0;
        let area = 'Forest';

        const display = document.createElement('p');

        updateDisplay();
        
        function rand(n){
            return Math.floor(Math.random() * n);
        }

        function d4(){
            return rand(4);
        }

        function d6(){
            return rand(6);
        }

        function d8(){
            return rand(8);
        }

        function d12(){
            return rand(12);
        }

        function d20(){
            return rand(20);
        }

        const monsterRoll = document.createElement('button');
        optionsContainer.appendChild(monsterRoll);

        optionsContainer.appendChild(hpContainer);

        optionsContainer.appendChild(gold);
        monsterRoll.textContent = 'Next Turn';
        
        const page = document.createElement('div');
        page.className = 'page noprint';
        document.body.appendChild(page);

        page.appendChild(display);

        const monsterRollOut = document.createElement('p');
        page.appendChild(monsterRollOut);
        

        function renderInventory(){
            const page = document.createElement('page');
            page.className = 'page';
            document.body.appendChild(page);

            function elem(n){
                const e = document.createElement(n);
                page.appendChild(e);
                return e;
            }


            page.appendChild(tableify(items.equipment,'Equipment'))

            page.appendChild(tableify(items.items,'Item'))

            const page2 = document.createElement('page');
            page2.className = 'page';
            document.body.appendChild(page2);

            const columns = ['armor','move','attack','int','cost','roll'];
            page2.appendChild(tableify(monsters.Forest,'Area 1 - Forest',columns,'monsterList'));
            page2.appendChild(tableify(monsters.Caves,'Area 2 - Caves',columns,'monsterList'));
            page2.appendChild(tableify(monsters.Village,'Area 3 - Village',columns,'monsterList'));

            const page3 = document.createElement('page');
            page3.className = 'page';
            document.body.appendChild(page3);
            page3.appendChild(tableify(items.Abilities,'Ability'));
        }

        Array.prototype.push_unique = function(n){
            if(!this.includes(n)){
                this.push(n);
            }
        }

        function tableify(obj,title,columns=[],className=''){
            if(columns.length === 0){
                for(let key in obj){
                    for(let sub in obj[key]){
                        columns.push_unique(sub);
                    }
                }
            }

            const table = document.createElement('table');
            
            const tr = document.createElement('tr');
            table.appendChild(tr);

            const td = document.createElement('td');
            td.textContent = title;
            tr.appendChild(td);

            for(let item of columns){
                const td = document.createElement('td');
                td.textContent = item;
                tr.appendChild(td);
            }

            for(let key in obj){
                const tr = document.createElement('tr');
                table.appendChild(tr);

                const td = document.createElement('td');
                td.textContent = key;
                tr.appendChild(td);

                for(let item of columns){
                    const td = document.createElement('td');
                    td.textContent = obj[key][item] || '';
                    tr.appendChild(td);
                }

            }

            table.className = className;

            return table;

        }


        function updateDisplay(){
            display.textContent = `${area} - Wave: ${wave}`;
        }

        const items = {
            equipment:{
                Sword:{
                    stats:"D6",
                    special:"",
                    cost:30,
                    sell:15
                },
                Dagger:{
                    stats:"D4",
                    special:"Move +1",
                    cost:16,
                    sell:8
                },
                Bow:{
                    stats:"D6, Range 3",
                    special:"Uses arrows, can retrieve, comes with 3 arrows",
                    cost:40,
                    sell:20
                },
                Shield:{
                    stats:"Armor +2",
                    special:"Counter: if 1H in other hand, D4>2, Attack Attacker",
                    cost:30,
                    sell:15
                },
                Spear:{
                    stats:"D6, Range 2, Pierce",
                    special:"Throw: Range 3, can retrieve, Damage +2",
                    cost:24,
                    sell:12
                },
                Whip:{
                    stats:"D8, Range 2",
                    special:"Will Damage +2",
                    cost:40,
                    sell:20
                },
                Great_Sword:{
                    stats:"D12, Knockback +1",
                    special:"Move -1",
                    cost:80,
                    sell:40
                },
                Wand:{
                    stats:"D4 / 2",
                    special:"Spell Damage + 2, Catalyst",
                    cost:90,
                    sell:45
                },
                Staff:{
                    stats:"D4",
                    special:"Spell Damage + 4, Catalyst, 2 Hand	",
                    cost:90,
                    sell:45
                },
                Great_Shield:{
                    stats:"Armor +3",
                    special:"Move -1",
                    cost:80,
                    sell:40
                },
                Axe:{
                    stats:"D8",
                    special:"",
                    cost:30,
                    sell:15
                },
                Great_Axe:{
                    stats:"D20, Knockback +1",
                    special:"Move -2, Two Handed",
                    cost:0,
                    sell:0
                },
                Scythe:{
                    stats:"D8, Pierce",
                    special:"3 Targets in row, Two Handed, Catalyst",
                    cost:60,
                    sell:30
                },
                Hammer:{
                    stats:"D12, Knockback +3",
                    special:"Move -1",
                    cost:50,
                    sell:25
                },
                Crossbow:{
                    stats:"D12, Range 4",
                    special:"uses bolts, can retrieve, comes with 3 bolts",
                    cost:80,
                    sell:40
                },
                Bolt_Action_Rifle:{
                    stats:"D20, Range 8",
                    special:"consumes 1 bullet, must reload after shot (consumes turn)",
                    cost:120,
                    sell:60
                },
                Revolver:{
                    stats:"D12, Range 4",
                    special:"consumes 1 bullet, must reload after 6 shots (consumes turn)",
                    cost:140,
                    sell:70
                },
                Claws:{
                    stats:"2D6",
                    special:"Move +1",
                    cost:40,
                    sell:20
                },
                Grimoire:{
                    stats:"D4 / 2",
                    special:"Spell Damage +2, has 2 random spells on pickup, Catalyst",
                    cost:-1,
                    sell:300
                },
                Iron_Gauntlets:{
                    stats:"2D4",
                    special:"Move +1, Grab Ability: D6 > target move - target weight, throw to any nearby tile",
                    cost:40,
                    sell:20
                }
            },
            items:{
                Health_Potion:{
                    type:"Consumable",
                    effect:"Heal +5",
                    cost:5,
                    sell:5
                },
                Arrow_x_3:{
                    type:"Ammo",
                    effect:"Reusable, Enchantable",
                    cost:5,
                    sell:2
                },
                Bullet_x_3:{
                    type:"Ammo",
                    effect:"Not Enchantable",
                    cost:5,
                    sell:2
                },
                Poison:{
                    type:"Consumable",
                    effect:"Apply to Sharp Weapon / Arrow / Bait, +2 Damage on targets with flesh for next 3 turns"
                },
                Bait:{
                    type:"Consumable",
                    effect:"Lure enemy to location, works with traps and poison",
                    cost:5,
                    sell:2.5
                },
                Anchor_Trap:{
                    type:"Trap",
                    effect:"D4 > 1 Enemy is trapped for 2 turns, explodes when stepping off",
                    cost:10,
                    sell:5
                },
                Bomb_Trap:{
                    type:"Trap",
                    effect:"D8 to tile and nearby surrounding tiles, explodes when stepping off",
                    cost:20,
                    sell:10
                },
                Sleep_Trap:{
                    type:"Trap",
                    effect:"D4 > 1 puts living enemies to sleep, explodes when stepping off",
                    cost:10,
                    sell:5
                },
                Whiskey:{
                    type:"Consumable",
                    effect:"increase max health by 5 for 3 turns, -1 to dodge rolls",
                    cost:15,
                    sell:10
                },
                Gas_Mask:{
                    type:"Equipable (Head)",
                    effect:"grants resistance to Sleep trap, Gas and Smells",
                    cost:30,
                    sell:15
                },
                Basic_Armor:{
                    type:"Equipable (Body)",
                    effect:"Armor +1",
                    cost:50,
                    sell:25
                },
                Full_Plate_Armor:{
                    type:"Equipable (Body)",
                    effect:"Armor +2, Move -1",
                    cost:80,
                    sell:40
                }
            },
            Abilities:{
                Fireball:{
                    cooldown:1,
                    ability:"D6 R3, Fire Damage, hits all nearby squares"
                },
                Raise_Dead:{
                    cooldown:2,
                    ability:"Corpse + D4 > 1, raise Controllable Zombie"
                },
                Chilling_Touch:{
                    cooldown:1,
                    ability:"Target has half movement speed for 2 turns"
                },
                Draining_Kiss:{
                    cooldown:1,
                    ability:"D6, caster gains damage as health; if target tranced, target loses next turn"
                },
                Trance:{
                    cooldown:2,
                    ability:"R2 target involuntarily moves towards caster for 2 turns and cannot attack caster, ends early if target is hurt"
                },
                Howl:{
                    cooldown:2,
                    ability:"R2 Allies gain +2 Damage for 1 turn"
                },
                Blink:{
                    cooldown:3,
                    ability:"teleport R5, if D4 > 3 can go through walls, otherwise end at wall"
                },
                Blessing:{
                    cooldown:3,
                    ability:"R3 Heal target for D6, if target doesn't have health, give 1 hp barrier"
                },
                Twist_Stone:{
                    cooldown:3,
                    ability:"Create Stone or Remove Stone"
                },
                Reflect:{
                    cooldown:3,
                    ability:"R2 Reflect next damage taken on attacker, up to R2"
                },
                Shift_Position:{
                    cooldown:3,
                    ability:"D4 > 1; exchange places with target, R4"
                },
                Pushing_Gale:{
                    cooldown:2,
                    ability:"R2 throw target up to R4 away from caster (as far as possible)"
                },
                Pulling_Gale:{
                    cooldown:2,
                    ability:"R4 pull target to caster"
                },
                Resurrect:{
                    cooldown:1,
                    ability:"Raise dead Ally to 50% health, drains casters health to 1"
                },
                Raise_Shadow:{
                    cooldown:2,
                    ability:"Create controllable Shadow Creature, caster loses 5 hp"
                },
                Double_Time:{
                    cooldown:2,
                    ability:"target gets 2 turns this round, back to back or additional turn after caster if already completed turn"
                },
                Mana_Bomb:{
                    cooldown:2,
                    ability:"R2 place large bomb, explodes in 2 turns for D12 damage to tile and surrounding tiles"
                },
                Blood_Bow:{
                    cooldown:1,
                    ability:"R6, D6, caster loses 1hp "
                },
                Anchor:{
                    cooldown:2,
                    ability:"target cannot move for 1 turn"
                },
                Gel:{
                    cooldown:3,
                    ability:"target loses next turn"
                }
            }
        }

        const monsters = {
            Forest:{
                Zombie:{
                    move:1,
                    armor:3,
                    int:"Dumb",
                    attack:"D4",
                    cost:1
                
                },
                Wolf:{
                    move:3,
                    armor:2,
                    int:"Dumb",
                    attack:"D6",
                    cost:3
                },
                Orc:{
                    move:2,
                    armor:3,
                    int:"Mid",
                    attack:"D6",
                    cost:3
                },
                Golem:{
                    move:1,
                    armor:4,
                    int:"Dumb",
                    attack:"D12",
                    cost:3
                },
                Skeleton_Warrior:{
                    move:2,
                    armor:2,
                    int:"Dumb",
                    attack:"D4",
                    cost:2
                },
                Skeleton_Archer:{
                    move:2,
                    armor:2,
                    int:"Smart",
                    attack:"D6 R3",
                    cost:3
                }
            },
            Caves:{
                Slime:{
                    move:2,
                    armor:4,
                    int:"Dumb",
                    attack:"D4",
                    cost:1
                },
                Bat:{
                    move:4,
                    armor:1,
                    int:"Dumb",
                    attack:"D6",
                    cost:2
                },
                Goblin_Archer:{
                    move:2,
                    armor:2,
                    int:"Dumb",
                    attack:"D6 R3",
                    cost:1
                },
                Necromancer:{
                    move:2,
                    armor:4,
                    int:"Smart",
                    attack:"Raise Undead; Vampiric Touch; D4",
                    cost:4
                },
                Werewolf:{
                    move:4,
                    armor:4,
                    int:"Dumb",
                    attack:"D8",
                    cost:5
                },
                Goblin_Medic:{
                    move:3,
                    armor:2,
                    int:"Smart",
                    attack:"Healing Touch; D6",
                    cost:3
                }
            },
            Village:{
                Enchanted_Wolf:{
                    move:3,
                    armor:3,
                    int:"Dumb",
                    attack:"D8; Howl",
                    cost:2
                },
                Enchanted_Bat:{
                    move:4,
                    armor:2,
                    int:"Dumb",
                    attack:"D8",
                    cost:0
                },
                Enslaved_Villager:{
                    move:2,
                    armor:2,
                    int:"Dumb",
                    attack:"D6 R2 Pierce",
                    cost:1
                },
                Enslaved_Soldier:{
                    move:2,
                    armor:4,
                    int:"Smart",
                    attack:"D8; can dodge",
                    cost:3
                },
                Enslaved_Archer:{
                    move:3,
                    armor:4,
                    int:"Smart",
                    attack:"D6 R3",
                    cost:3
                },
                Minor_Succubus:{
                    move:3,
                    hp:6,
                    armor:4,
                    int:"Smart",
                    attack:"Draining Kiss, Trance, D6; can dodge",
                    cost:3
                }
            }
        }

        for(let key in monsters){
            let i = 1;
            for(let entry in monsters[key]){
                monsters[key][entry].hp = monsters[key][entry].hp || 1; 
                monsters[key][entry].roll = i;
                i += 1;
            }
        }

        for(let key in items){
            let i = 1;
            for(let item in items[key]){
                items[key][item].roll = i;
                i+= 1;
            }
        }

        renderInventory();
    
        function monsterStats(monster){
            monster = monster.replace(' ','_');
            for(let key in monsters){
                if(monsters[key][monster]){
                    const data = monsters[key][monster];
                    return `<h3>${monster.replace('_',' ')}</h3> Armor ${data.armor},  Move ${data.move}, Attack ${data.attack}, ${data.int}`;
                }
            }
        }

        function getMonster(monster){
            monster = monster.replace(' ','_');
            for(let key in monsters){
                if(monsters[key][monster]){
                    return monsters[key][monster];
                }
            }
        }

        monsterRoll.addEventListener('mousedown',nextTurn,false);
        nextTurn();

        function counter(n,callback){
            const span = document.createElement('span');
            span.className = 'counter';
            
            const out = document.createElement('span');
            
            const lower =document.createElement('button');
            lower.addEventListener('mousedown',function(){
                n -= 1
                out.textContent = n;
                callback(n);
            });
            lower.textContent = '<';
            
            const higher =document.createElement('button');
            higher.addEventListener('mousedown',function(){
                n += 1
                out.textContent = n;
                callback(n);
            });
            higher.textContent = '>';

            out.textContent = n;
            span.appendChild(lower);
            span.appendChild(out);
            span.appendChild(higher);
            return span;    
        }

        function nextTurn(){
            wave += 1
            if(wave > 10){
                wave = 1;
                if(area === 'Forest'){
                    area = 'Caves';
                }else if(area === 'Caves'){
                    area = "Village";
                }
            }


            const areas = {
                Forest:Object.keys(monsters.Forest),
                Caves:Object.keys(monsters.Caves),
                Village:Object.keys(monsters.Village),

            }

            monsterRollOut.innerHTML = '<hr/>';

            if(wave % 5 === 0){
                monsterRollOut.innerHTML += '<h3>Traveling Merchant</h3> Anything of interest? <br/><br/>';

                for(let i = 0; i < 4; i++){
                    const d = d4();
                    if(d === 0 || d === 1){
                        let keys = Object.keys(items.items);
                        const key = keys[Math.floor(Math.random()*keys.length)]
                        const item = items.items[key];
                        monsterRollOut.innerHTML += `<b>${key}</b> ${item.type}, ${item.effect} - ${item.cost} / ${item.sell}<br/>`;
                    }else{
                        let keys = Object.keys(items.equipment);
                        const key = keys[Math.floor(Math.random()*keys.length)]
                        const item = items.equipment[key];
                        monsterRollOut.innerHTML += `<b>${key}</b> ${item.stats}, ${item.special} - ${item.cost} / ${item.sell}<br/>`;
                    }
                }

                monsterRollOut.innerHTML += "<hr/>";
            }
            let first = true;
            let cc = wave;
            while(cc >= 0){
                let next = areas[area][d6()];
                const monster = getMonster(next);
                if(cc - monster.cost >= 0  || first){
                    first = false;
                    let position = [d4()+1,d4()+1,d4()+1];
                    monsterRollOut.innerHTML += `${monsterStats(next)} <br/> Position ${position[0]},${position[1]},${position[2]}<br/><br/>`;
                }
                cc -= monster.cost;
            }

            updateDisplay();
        }

    </script>
</body>
</html>