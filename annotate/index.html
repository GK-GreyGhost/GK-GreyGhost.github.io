<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annotate</title>
    <style>
        
        *{
            position:relative;
            margin:0px;
            box-sizing: border-box;
            font-family:helvetica;
        }

        body{
            background:#222;
        }
        
        #fileInput{
            display:none;
        }
        
        #dropContainer{
            position:fixed;
            top:0px;
            left:0px;
            width:100%;
            height:100%;
        }

        #dropContainer:after{
            content:"Drop file here";
            position:fixed;
            top:0px;
            left:0px;
            right:0px;
            bottom:0px;
            font-size:4em;
            opacity:0.25;
            margin:auto;
            color:#fff;
            height:40px;
            text-align:center;
        }

        .lineContainer{
            position:fixed;
            bottom:0px;
            right:0px;
            background:#fff;
            overflow:hidden;
            border:solid 1px #000;
            opacity:0.25;
            max-width:calc(100% - 20px);
        }

        input{
            outline:none;
            border:solid 1px #000;
            padding:5px;
            height:100%;
            text-align:center;
        }

        .line{
            display:flex;
            height:50px;
        }

        .line *{
            outline:none;
            border:none;
        }

        .lineContainer div, .lineContainer input{
            padding:2px;
            margin:2px;
        }

        textarea{
            resize:none;
        }

    </style>
</head>
<body>
    <div id="dropContainer"></div>
       <input type="file" id="fileInput" />
    <script>
        let Mouse = {x:0,y:0};
        
        if(localStorage.save){
            baseData = JSON.parse(localStorage.save);
        }

        const save = new Proxy(baseData,{
            set(target, key, value) {
                target[key] = value;
                localStorage.save = JSON.stringify(target);
            },
            get(target,key){
                return target[key];
            }
        });

        dropContainer.ondragover = dropContainer.ondragenter = function(evt) {
            evt.preventDefault();
            return false;
        };

        dropContainer.ondrop = function(evt) {
            
            for(let i = 0; i < evt.dataTransfer.files.length; i++){
                const reader = new FileReader();
                reader.onload = function(e){
                    const img = new Image();
                    img.onload = function(){
                        dropContainer.remove();

                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        document.body.appendChild(canvas);

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img,0,0);
                        ctx.font = '20px ariel';
                        ctx.textAlign = 'center';
                        const lineContainer = document.createElement('div');
                        lineContainer.className = 'lineContainer';
                        document.body.appendChild(lineContainer);
                        let boundingBoxes = [];
                        addLine();
                        
                        let selected;
                        
                        function addLine(x=50,y=50){

                            const div = document.createElement('div');
                            div.className = 'line';
                            lineContainer.appendChild(div);

                            const input = document.createElement('textarea');
                            div.appendChild(input);
                            
                            const position = document.createElement('input');
                            position.value = (x).toFixed(2) + ' ' + (y).toFixed(2);
                            position.addEventListener('keyup',redraw);
                            
                            div.appendChild(position);

                            const font = document.createElement('input');
                            font.value = 'bold 20px ariel';
                            font.addEventListener('keyup',redraw);

                            div.appendChild(font);

                            const color = document.createElement('input');
                            color.addEventListener('keyup',redraw);
                            color.value = '#777';
                            div.appendChild(color);

                            input.addEventListener('keyup',function(){
                                redraw();
                                if(lineContainer.lastChild.children[0] == input){
                                    addLine(x,y+50);
                                }
                            },false);

                            redraw();
                        }

                        document.body.addEventListener('mousedown',function(e){
                            const x = e.pageX;
                            const y = e.pageY;
                            Mouse.x = x;
                            Mouse.y = y;

                            for(let box of boundingBoxes){
                                if(x > box.x && x < box.x + box.width && y > box.y && y < box.y + box.height){
                                    selected = box;
                                }
                            }
                        },false);

                        document.body.addEventListener('mousemove',function(e){

                            const x = e.pageX;
                            const y = e.pageY;
                            Mouse.x = x;
                            Mouse.y = y;

                            if(!selected){
                                return;
                            }
 
                            selected.positionElem.value = x + ' ' + y;
                            redraw();

                        },false);

                        document.body.addEventListener('mouseup',function(){
                            selected = false;
                        },false);

                        function redraw(){
                            boundingBoxes = [];
                            ctx.drawImage(img,0,0);
                            ctx.fillStyle = 'red';
                            //ctx.fillRect(Mouse.x-5,Mouse.y-5,10,10);
                            for(let item of lineContainer.children){
                                
                                const position = item.children[1].value.split(' ');
                                
                                const x = parseFloat(position[0],10);
                                let y = parseFloat(position[1],10);

                                ctx.font = item.children[2].value;
                                ctx.fillStyle = item.children[3].value;
                                if(x < canvas.width * 0.2){
                                    ctx.textAlign = 'left';
                                }else if(x > canvas.width * 0.8){
                                    ctx.textAlign = 'right';
                                }else{
                                    ctx.textAlign = 'center';
                                }
                                const text = item.children[0].value.split('\n');
                                for(let line of text){
                                    const metrics = ctx.measureText(line);
                                    const height = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
                                    const width = metrics.width;
                                    ctx.lineWidth = 5;
                                    ctx.strokeStyle = '#000';
                                    ctx.fillStyle = '#fff';
                                    ctx.strokeText(line,x,y);
                                    ctx.fillText(line,x,y);
                                    y += height * 1.5;
                                    boundingBoxes.push({
                                        x:x,y:y-height*2,width,height,element:item,positionElem:item.children[1]
                                    });
                                }

                            }
                            /*
                            ctx.lineWidth = 3;
                            ctx.strokeStyle = 'red';
                            for(let box of boundingBoxes){
                                ctx.strokeRect(box.x,box.y,box.width,box.height);
                            }
                            */
                        }

                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(evt.dataTransfer.files[i]);
            }

            evt.preventDefault();
            return false;
        };

        window.addEventListener("dragover",function(e){
            e = e || event;
            e.preventDefault();
        },false);
        window.addEventListener("drop",function(e){
            e = e || event;
            e.preventDefault();
        },false);

    </script>
</body>
</html>